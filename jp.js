let jState={L:{img:null,zoom:1,rot:0,straighten:0,flip:1,x:0,y:0,br:100,ct:100,st:100},R:{img:null,zoom:1,rot:0,straighten:0,flip:1,x:0,y:0,br:100,ct:100,st:100}},jCanvas,jCtx,jActiveSide=null,isJDragging=!1,jStartX,jStartY,jLastMoveTime=0,hasMovedJ=!1,jInputLock=0;const JOINT_PRO_KEYS=["G6nRerni4niQACNWuWg7Kvi1","UxybaW3vfo8j4wZfXbvo3ajP","VAnV2Qwn7GncCJBgVwVMTK2J","d1QDMnVQCwxqdyhYXRVRBW33"];let jActiveKeyIndex=0,jGlobalBG="#ffffff",jBorderWidth=0;function openJointProModal(){setActiveMode("mode-joint-pro"),document.getElementById("jointProModal").style.display="flex",document.body.style.overflow="hidden",jCtx=(jCanvas=document.getElementById("jointProCanvas")).getContext("2d"),jCanvas.width=570,jCanvas.height=450,setupJEvents(),renderJPro()}function closeJointProModal(){document.getElementById("jointProModal").style.display="none",document.body.style.overflow="auto"}function handleJCanvasClick(t){let e=Date.now();if(e-jInputLock<500||hasMovedJ||isJDragging||e-jLastMoveTime<300)return;let a=jCanvas.getBoundingClientRect(),n=t.changedTouches?t.changedTouches[0].clientX:t.clientX,o=(n-a.left)*(jCanvas.width/a.width),i=o<jCanvas.width/2?"L":"R";null===jState[i].img&&(jInputLock=e,document.getElementById("jInput"+i).click())}function rotateJoint(t){jState[t].rot=(jState[t].rot+90)%360,renderJPro()}function flipJoint(t){jState[t].flip*=-1,renderJPro()}function setupJEvents(){let t=t=>{let e=jCanvas.getBoundingClientRect(),a=t.touches&&t.touches[0]?t.touches[0].clientX:t.clientX,n=t.touches&&t.touches[0]?t.touches[0].clientY:t.clientY;return{x:(a-e.left)*(jCanvas.width/e.width),rawX:a,rawY:n}},e=e=>{if("INPUT"===e.target.tagName||"range"===e.target.type){isJDragging=!1;return}let a=t(e);jActiveSide=a.x<jCanvas.width/2?"L":"R",hasMovedJ=!1,e.target===jCanvas&&jState[jActiveSide].img&&(isJDragging=!0,jStartX=a.rawX,jStartY=a.rawY)},a=e=>{if(!isJDragging)return;let a=t(e);(Math.abs(a.rawX-jStartX)>5||Math.abs(a.rawY-jStartY)>5)&&(hasMovedJ=!0,jLastMoveTime=Date.now(),jState[jActiveSide].x+=a.rawX-jStartX,jState[jActiveSide].y+=a.rawY-jStartY,jStartX=a.rawX,jStartY=a.rawY,renderJPro()),e.cancelable&&e.preventDefault()},n=t=>{isJDragging?isJDragging=!1:t.target===jCanvas&&handleJCanvasClick(t),"touchend"===t.type&&t.cancelable&&t.target===jCanvas&&t.preventDefault(),setTimeout(()=>{hasMovedJ=!1},150)};jCanvas.onmousedown=e,jCanvas.addEventListener("touchstart",e,{passive:!1}),window.addEventListener("mousemove",a,{passive:!1}),window.addEventListener("touchmove",a,{passive:!1}),window.addEventListener("mouseup",n),window.addEventListener("touchend",n),["Br","Ct","St","Straighten","Zoom"].forEach(t=>{let e="Straighten"===t?"straighten":t.toLowerCase();["L","R"].forEach(a=>{let n=document.getElementById("j"+t+a);n&&(n.oninput=n=>{let o="Zoom"===t?parseFloat(n.target.value):parseInt(n.target.value);jState[a][e]=o;let i="Zoom"===t?o.toFixed(2):o;document.getElementById("v-j"+t+a).innerText=i+("Straighten"===t?"\xb0":"Zoom"===t?"x":"%"),renderJPro()},n.addEventListener("touchstart",t=>t.stopPropagation(),{passive:!0}),n.addEventListener("touchmove",t=>t.stopPropagation(),{passive:!0}))})}),document.getElementById("jBorder").oninput=t=>{jBorderWidth=parseInt(t.target.value),document.getElementById("v-jBorder").innerText=jBorderWidth+"px",renderJPro()},document.getElementById("jInputL").onchange=t=>loadJImg(t.target.files[0],"L"),document.getElementById("jInputR").onchange=t=>loadJImg(t.target.files[0],"R")}function loadJImg(t,e){if(!t)return;let a=new FileReader;a.onload=t=>{let a=new Image;a.onload=()=>{jState[e].img=a,jState[e].x=0,jState[e].y=0,document.getElementById("jHint"+e).style.display="none",renderJPro()},a.src=t.target.result},a.readAsDataURL(t)}async function removeJointBg(t){if(!jState[t].img)return showAlert("Please add photo first!");let e=document.getElementById("jAiBtn"+t),a='<i class="fa-solid fa-wand-sparkles"></i> Background Removed';e.disabled=!0,e.innerHTML="<i class='fa-solid fa-spinner fa-spin'></i> Please wait...";let n=jState[t].img.width,o=document.createElement("canvas");o.width=jState[t].img.width,o.height=jState[t].img.height,o.getContext("2d").drawImage(jState[t].img,0,0),o.toBlob(async o=>{let i=new FormData;i.append("image_file",o);try{let r=await fetch("https://api.remove.bg/v1.0/removebg",{method:"POST",headers:{"X-Api-Key":JOINT_PRO_KEYS[jActiveKeyIndex]},body:i});if(r.ok){let l=await r.blob(),d=new Image;d.onload=()=>{let o=n/d.width;jState[t].zoom=jState[t].zoom*o,document.getElementById("jZoom"+t).value=jState[t].zoom,document.getElementById("v-jZoom"+t).innerText=parseFloat(jState[t].zoom).toFixed(2)+"x",jState[t].img=d,renderJPro(),e.innerHTML=a,e.disabled=!1},d.src=URL.createObjectURL(l)}else if(402===r.status||403===r.status){if(++jActiveKeyIndex<JOINT_PRO_KEYS.length)removeJointBg(t);else throw jActiveKeyIndex=0,Error("All API limits exceeded!")}else throw Error("API Error")}catch(s){showAlert(s.message),e.innerHTML=a,e.disabled=!1}},"image/png")}function deleteJointImage(t){jState[t].img=null,jState[t].zoom=1,jState[t].rot=0,jState[t].straighten=0,jState[t].flip=1,jState[t].x=0,jState[t].y=0,jState[t].br=100,jState[t].ct=100,jState[t].st=100,document.getElementById("jInput"+t).value="",document.getElementById("jZoom"+t).value=1,document.getElementById("v-jZoom"+t).innerText="1.0x",document.getElementById("jStraighten"+t).value=0,document.getElementById("v-jStraighten"+t).innerText="0\xb0",["Br","Ct","St"].forEach(e=>{document.getElementById("j"+e+t).value=100,document.getElementById("v-j"+e+t).innerText="100%"});let e=document.getElementById("jHint"+t);e&&(e.style.display="flex"),renderJPro()}function renderJPro(){jCtx&&(jCtx.fillStyle=jGlobalBG,jCtx.fillRect(0,0,jCanvas.width,jCanvas.height),drawJSide("L",0,285),drawJSide("R",285,285),jBorderWidth>0&&(jCtx.strokeStyle="#000000",jCtx.lineWidth=2*jBorderWidth,jCtx.strokeRect(0,0,jCanvas.width,jCanvas.height)))}function drawJSide(t,e,a){let n=jState[t];n.img&&(jCtx.save(),jCtx.beginPath(),jCtx.rect(e,0,a,jCanvas.height),jCtx.clip(),jCtx.translate(e+a/2+n.x,jCanvas.height/2+n.y),jCtx.rotate((n.rot+n.straighten)*Math.PI/180),jCtx.scale(n.zoom*n.flip,n.zoom),jCtx.filter=`brightness(${n.br}%) contrast(${n.ct}%) saturate(${n.st}%)`,jCtx.drawImage(n.img,-n.img.width/2,-n.img.height/2),jCtx.restore())}function downloadJointPro(t){if(!jState.L.img||!jState.R.img)return showAlert("Please add both photos first!");let e=parseInt(document.getElementById("jRows").value)||1,a=parseInt(document.getElementById("jCols").value)||1,n=jCanvas.toDataURL("image/jpeg",.95);if("jpg"===t){let o=document.createElement("a");o.download="Bank_Joint_Photo.jpg",o.href=n,o.click()}else{let{jsPDF:i}=window.jspdf,r=new i("p","mm","a4"),l=(210-(48.26*a+(a-1)*2))/2;for(let d=0;d<e;d++)for(let s=0;s<a;s++){let j=l+50.26*s,g=5+40.1*d;j+48.26<=210&&g+38.1<=297&&r.addImage(n,"JPEG",j,g,48.26,38.1)}r.save("Bank_Joint_Photo_A4.pdf")}}window.adjustJLayout=function(t,e){let a=document.getElementById(t),n=parseInt(a.value)||1;n+=e,"jRows"===t?(n<1&&(n=1),n>7&&(n=7)):"jCols"===t&&(n<1&&(n=1),n>4&&(n=4)),a.value=n},window.setGlobalJBG=function(t){jGlobalBG=t,renderJPro()};
