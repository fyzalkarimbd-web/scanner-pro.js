<!-- SCRIPT 1: Globals & Basic Utils -->

let cvLoaded=!1;const imageStates={front:{input:null,canvas:null,ctx:null,loupe:null,loupeCtx:null,image:null,points:[],activePoint:-1,originalCropped:null,croppedResult:null,filterLevel:0},back:{input:null,canvas:null,ctx:null,loupe:null,loupeCtx:null,image:null,points:[],activePoint:-1,originalCropped:null,croppedResult:null,filterLevel:0}};function setActiveMode(l){document.querySelectorAll(".mode-card-btn").forEach(l=>l.classList.remove("active"));let e=document.getElementById(l);e&&e.classList.add("active")}

function showAlert(l){let e=document.getElementById("popupMessage"),t=document.getElementById("customPopup");e&&t?(e.innerText=l,t.classList.add("active")):alert(l)}function closePopup(){let l=document.getElementById("customPopup");l&&l.classList.remove("active")}


    <!-- SCRIPT 2: Visual Effects (Particles) -->

!function(){let e=document.getElementById("particles-container");if(e){for(let t=0;t<15;t++){let r=document.createElement("div");r.classList.add("particle");let l=20*Math.random()+30;r.style.width=`${l}px`,r.style.height=`${l}px`,r.style.left=`${100*Math.random()}vw`,r.style.top=`${100*Math.random()}vh`,r.style.setProperty("--moveX",`${(Math.random()-.5)*100}vw`),r.style.setProperty("--moveY",`${(Math.random()-.5)*100}vh`),r.style.setProperty("--duration",`${20*Math.random()+15}s`),r.style.setProperty("--delay",`${-30*Math.random()}s`),r.style.setProperty("--opacity",.5*Math.random()+.2),e.appendChild(r)}}}();


    <!-- SCRIPT 3: Share & Menu Logic -->
    
      function toggleShareMenu(){if(navigator.share)navigator.share({title:document.title,text:"Check out this free ID Card Scanner tool!",url:window.location.href}).catch(console.error);else{let e=document.getElementById("shareWrapper");e&&(e.classList.toggle("active"),setTimeout(()=>{document.addEventListener("click",function t(r){e.contains(r.target)||(e.classList.remove("active"),document.removeEventListener("click",t))})},100))}}function shareTo(e){let t=encodeURIComponent(window.location.href),r=encodeURIComponent("Check out this free ID Card Scanner tool! "+document.title),i="";if("facebook"===e)i=`https://www.facebook.com/sharer/sharer.php?u=${t}`;else if("whatsapp"===e)i=`https://api.whatsapp.com/send?text=${r} ${t}`;else if("twitter"===e)i=`https://twitter.com/intent/tweet?text=${r}&url=${t}`;else if("copy"===e){navigator.clipboard.writeText(window.location.href).then(()=>{alert("Link copied!")});return}i&&window.open(i,"_blank","width=600,height=400")}
      

    <!-- SCRIPT 4: System Init & File Upload (Speed Optimized) -->
    
      function onOpenCvReady(){cvLoaded=!0;let e=document.getElementById("status");e&&(e.innerText="✅ Tool Ready. Upload an image.",e.style.background="#ecfdf5",e.style.color="#059669"),initScanner()}function onOpenCvError(){let e=document.getElementById("status");e&&(e.innerText="❌ Error: OpenCV failed to load.")}function initScanner(){document.getElementById("id-scanner-wrapper")&&(initSide("front"),initSide("back"),updateButtonState("front"),updateButtonState("back"))}function initSide(e){let t=imageStates[e];if(t.input=document.getElementById(e+"Input"),t.canvas=document.getElementById(e+"Canvas"),t.loupe=document.getElementById(e+"Loupe"),!t.input||!t.canvas)return;t.ctx=t.canvas.getContext("2d",{willReadFrequently:!0}),t.loupe&&(t.loupeCtx=t.loupe.getContext("2d"),t.loupe.width=120,t.loupe.height=120);let n=n=>{if(!n)return;let a=new FileReader;a.onload=n=>{let a=new Image;a.onload=()=>{let n=a.width,l=a.height;if(n>1500||l>1500){let o=Math.min(1500/n,1500/l);n=Math.floor(n*o),l=Math.floor(l*o)}let r=document.createElement("canvas");r.width=n,r.height=l;let i=r.getContext("2d");i.drawImage(a,0,0,n,l);let d=new Image;d.onload=()=>{t.image=d,t.croppedResult=null,t.originalCropped=null,t.filterLevel=0,updateFilterUI(e),t.canvas.width=n,t.canvas.height=l,t.points=[{x:.1*n,y:.1*l},{x:.9*n,y:.1*l},{x:.9*n,y:.9*l},{x:.1*n,y:.9*l}],document.getElementById(e+"Status").classList.add("d-none"),document.getElementById(e+"RotateBtn").style.display="flex",document.getElementById(e+"RemoveBtn").style.display="flex",drawUI(e),updateButtonState(e),document.getElementById("filterControls"+("front"===e?"Front":"Back")).classList.remove("active")},d.src=r.toDataURL("image/jpeg",.85)},a.src=n.target.result},a.readAsDataURL(n)};t.input.onchange=e=>n(e.target.files[0]);let a=document.getElementById(e+"DropZone");a&&(a.ondragover=e=>{e.preventDefault(),a.classList.add("dragover")},a.ondragleave=()=>a.classList.remove("dragover"),a.ondrop=e=>{e.preventDefault(),a.classList.remove("dragover"),e.dataTransfer.files.length&&n(e.dataTransfer.files[0])}),setupCanvasEvents(e,t)}
      

    <!-- SCRIPT 5: Super Smooth Drag & Smart Center Magnifier -->
    
      function setupCanvasEvents(t,e){let n=!1,a=0,i=0,o=(t,n)=>{let a=e.canvas.getBoundingClientRect();return{x:(t-a.left)*(e.canvas.width/a.width),y:(n-a.top)*(e.canvas.height/a.height)}},c=()=>{if(n&&-1!==e.activePoint){let l=o(a,i);e.points[e.activePoint]={x:Math.max(0,Math.min(e.canvas.width,l.x)),y:Math.max(0,Math.min(e.canvas.height,l.y))},drawUI(t),updateMagnifier(t,e.points[e.activePoint]),requestAnimationFrame(c)}},l=t=>{if(!e.image||e.croppedResult)return;let l=t.touches?t.touches[0].clientX:t.clientX,s=t.touches?t.touches[0].clientY:t.clientY,p=o(l,s),r=Math.max(.15*e.canvas.width,60),$=-1;for(let u=0;u<4;u++){let d=p.x-e.points[u].x,v=p.y-e.points[u].y,h=Math.sqrt(d*d+v*v);h<r&&(r=h,$=u)}-1!==$&&(e.activePoint=$,n=!0,a=l,i=s,t.cancelable&&t.preventDefault(),requestAnimationFrame(c))},s=t=>{n&&(t.cancelable&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),a=t.touches?t.touches[0].clientX:t.clientX,i=t.touches?t.touches[0].clientY:t.clientY)},p=a=>{n&&(a.cancelable&&a.preventDefault(),n=!1,e.activePoint=-1,e.loupe&&(e.loupe.style.display="none"),drawUI(t))};e.canvas.addEventListener("touchstart",l,{passive:!1}),e.canvas.addEventListener("touchmove",s,{passive:!1}),e.canvas.addEventListener("touchend",p,{passive:!1}),e.canvas.addEventListener("touchcancel",p,{passive:!1}),e.canvas.addEventListener("mousedown",l),document.addEventListener("mousemove",s),document.addEventListener("mouseup",p)}function updateMagnifier(t,e){let n=imageStates[t];if(!n.loupe||!n.loupeCtx||!n.image)return;n.loupe.style.display="block",n.loupeCtx.imageSmoothingEnabled=!1;let a=n.canvas.width,i=n.canvas.height,o="50%",c="50%";n.canvas.getBoundingClientRect();let l=e.x/a,s=e.y/i;l>.3&&l<.7&&s>.3&&s<.7&&(o=l<.5?"85%":"15%",c=s<.5?"85%":"15%"),n.loupe.style.left=o,n.loupe.style.top=c,n.loupe.style.transform="translate(-50%, -50%)";let p=n.loupeCtx,r=n.loupe.width,$=n.loupe.height;p.clearRect(0,0,r,$),p.drawImage(n.image,e.x-r/2/3,e.y-$/2/3,r/3,$/3,0,0,r,$),p.lineWidth=1,p.strokeStyle="rgba(255, 0, 0, 0.8)",p.beginPath(),p.moveTo(r/2,0),p.lineTo(r/2,$),p.moveTo(0,$/2),p.lineTo(r,$/2),p.stroke(),p.fillStyle="rgba(255, 255, 0, 0.5)",p.fillRect(r/2-2,$/2-2,4,4)}function drawUI(t){let e=imageStates[t];if(e.ctx){if(e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.ctx.imageSmoothingEnabled=!0,e.croppedResult){e.ctx.drawImage(e.croppedResult,0,0);return}e.image&&e.ctx.drawImage(e.image,0,0),4===e.points.length&&(e.ctx.beginPath(),e.ctx.lineWidth=2,e.ctx.strokeStyle="#00e5ff",e.ctx.moveTo(e.points[0].x,e.points[0].y),e.ctx.lineTo(e.points[1].x,e.points[1].y),e.ctx.lineTo(e.points[2].x,e.points[2].y),e.ctx.lineTo(e.points[3].x,e.points[3].y),e.ctx.closePath(),e.ctx.stroke(),e.points.forEach((t,n)=>{e.ctx.beginPath();let a=Math.max(10,.02*e.canvas.width);n===e.activePoint?(e.ctx.fillStyle="rgba(255, 255, 0, 0.9)",a*=1.3):e.ctx.fillStyle="rgba(79, 70, 229, 0.8)",e.ctx.arc(t.x,t.y,a,0,2*Math.PI),e.ctx.fill(),e.ctx.strokeStyle="#fff",e.ctx.lineWidth=2,e.ctx.stroke()}))}}
      

    <!-- SCRIPT 6: Rotate & Remove Actions -->
    
      function updateButtonState(t){let e=imageStates[t],a=cvLoaded&&!!e.image,n=document.getElementById("front"===t?"btnCropFront":"btnCropBack"),i=document.getElementById("front"===t?"btnMagicFront":"btnMagicBack");n&&(n.disabled=!a||!!e.croppedResult),i&&(i.disabled=!e.croppedResult)}function removeImage(t){let e=imageStates[t];e.image=null,e.croppedResult=null,e.originalCropped=null,e.points=[],e.filterLevel=0,e.canvas.width=0,e.canvas.height=0,e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.input.value="",document.getElementById(t+"Status").classList.remove("d-none"),document.getElementById(t+"RotateBtn").style.display="none",document.getElementById(t+"RemoveBtn").style.display="none",updateButtonState(t),document.getElementById("filterControls"+("front"===t?"Front":"Back")).classList.remove("active")}function rotateImage(t){let e=imageStates[t];if(!e.image)return;let a=document.createElement("canvas"),n=a.getContext("2d");a.width=e.image.height,a.height=e.image.width,n.translate(a.width/2,a.height/2),n.rotate(90*Math.PI/180),n.drawImage(e.image,-e.image.width/2,-e.image.height/2);let i=new Image;i.onload=()=>{e.image=i,e.croppedResult=null,e.originalCropped=null,e.filterLevel=0,updateFilterUI(t),e.canvas.width=i.width,e.canvas.height=i.height;let a=i.width,n=i.height;e.points=[{x:.1*a,y:.1*n},{x:.9*a,y:.1*n},{x:.9*a,y:.9*n},{x:.1*a,y:.9*n}],document.getElementById(t+"Status").classList.add("d-none"),drawUI(t),updateButtonState(t)},i.src=a.toDataURL()}
      

    <!-- SCRIPT 7: Heavy Processing (OpenCV, Filter, Export) -->

let currentMode="id";function switchMode(e){currentMode=e;let t=document.getElementById("main-tool-icon"),n=document.getElementById("tool-title"),r=document.getElementById("tool-sub"),o=document.getElementById("tool-instruction"),s=document.getElementById("front-label"),a=document.getElementById("back-label"),i=document.getElementById("front-icon"),l=document.getElementById("back-icon");"passport"===e?(t&&(t.src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhonxbHVZCeBp2oTkvSGR7cy05IwwYynoHe86vV7pUzuQ5EsXnfGneQd80O8EDv9lr4Mynr_GEvmfXYyJXn90WdZ6XrJoZEzvul5tAVfNV5B1DfqNltAl0SreChyphenhypheny3GzOr5MKfNPsSP4bypPJwGQiZW35WdPYYIAVUv06_kyUPO8KXVLw/s1600/passport.webp"),n&&(n.innerText="Passport Scan To Pdf"),r&&(r.innerText="100% Free • Secure • Passport A4 Pdf Print Ready"),o&&(o.innerHTML="<p><strong>How to use:</strong> Capture <strong>Top & Down</strong> parts of Passport. Adjust lines, apply <strong>Magic Filter</strong>, and save.</p>"),s&&(s.innerText="Passport Top Part"),a&&(a.innerText="Passport Down Part"),i&&(i.innerHTML='<i class="fa-solid fa-passport"></i>'),l&&(l.innerHTML='<i class="fa-solid fa-passport"></i>')):(t&&(t.src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipk4QDHjvM6rOJEXy-n1ty4D2zr_vtEtTozfVgEbsvASVjqs8ge3INfwMwLB833IpqzpFk4deXFgwvYzgy-9vwhtkKe9pdixkFrAqrSvkLhoFsBYCykwbieuD1GXwxAI_enBMTXj4tncYBJjlIrV8XlxJcvONHmNSs1bOAbFGLO5oNHg/s150/ID-Card.webp"),n&&(n.innerText="ID Card Scan To Pdf"),r&&(r.innerText="100% Free • Secure • ID Card A4 Pdf Print Ready"),o&&(o.innerHTML="<p><strong>How to use:</strong> Capture <strong>Front & Back</strong> of ID card. Adjust lines, apply <strong>Magic Filter</strong>, and save.</p>"),s&&(s.innerText="ID Card Front Side"),a&&(a.innerText="ID Card Back Side"),i&&(i.innerHTML='<i class="fa-solid fa-id-card"></i>'),l&&(l.innerHTML='<i class="fa-solid fa-address-card"></i>'))}window.onload=function(){document.querySelectorAll(".mode-card-btn").forEach(e=>e.classList.remove("active"))};

  
  <!-- SCRIPT 7B: Image Processing Engine -->

async function applyPerspectiveCrop(side){if(!cvLoaded)return;let state=imageStates[side];try{state.ctx.drawImage(state.image,0,0,state.canvas.width,state.canvas.height);let src=cv.imread(state.canvas),dst=new cv.Mat(),pts1=cv.matFromArray(4,1,cv.CV_32FC2,[state.points[0].x,state.points[0].y,state.points[1].x,state.points[1].y,state.points[2].x,state.points[2].y,state.points[3].x,state.points[3].y]),pts2=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,1000,0,1000,630,0,630]),M=cv.getPerspectiveTransform(pts1,pts2);cv.warpPerspective(src,dst,M,new cv.Size(1000,630),cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar());let canvas=document.createElement("canvas");cv.imshow(canvas,dst);state.originalCropped=canvas;state.croppedResult=canvas;state.filterLevel=0;updateFilterUI(side);src.delete();dst.delete();M.delete();pts1.delete();pts2.delete();state.canvas.width=1000;state.canvas.height=630;drawUI(side);updateButtonState(side)}catch(e){alert("Crop failed! Please adjust points.")}}async function applyMagicFilter(side){let state=imageStates[side];if(!state.originalCropped)return;if(state.filterLevel===0){state.croppedResult=state.originalCropped;state.ctx.drawImage(state.originalCropped,0,0);return}try{let src=cv.imread(state.originalCropped),dst=new cv.Mat();cv.cvtColor(src,dst,cv.COLOR_RGBA2RGB,0);cv.cvtColor(dst,dst,cv.COLOR_RGB2Lab,0);let channels=new cv.MatVector();cv.split(dst,channels);let clahe=new cv.CLAHE(2,new cv.Size(8,8));clahe.apply(channels.get(0),channels.get(0));cv.merge(channels,dst);cv.cvtColor(dst,dst,cv.COLOR_Lab2RGB,0);let alpha=1+(state.filterLevel*0.1),beta=state.filterLevel*8;dst.convertTo(dst,-1,alpha,beta);let canvas=document.createElement("canvas");cv.imshow(canvas,dst);state.croppedResult=canvas;state.ctx.drawImage(canvas,0,0);src.delete();dst.delete();channels.delete();clahe.delete()}catch(e){console.error(e)}}function toggleMagicControls(e){let t=document.getElementById("filterControls"+("front"===e?"Front":"Back"));t.classList.contains("active")||(t.classList.add("active"),0===imageStates[e].filterLevel&&adjustMagic(e,1))}function adjustMagic(e,t){let a=imageStates[e],r=a.filterLevel+t;if(r>=0&&r<=5){a.filterLevel=r;updateFilterUI(e);applyMagicFilter(e)}}function updateFilterUI(e){let t=document.getElementById("filterLevel"+("front"===e?"Front":"Back"));if(t)t.innerText=0===imageStates[e].filterLevel?"Original":"Level: "+imageStates[e].filterLevel}

  
  <!-- SCRIPT 7C: Layout & Export Tool -->

function getA4Canvas(){let e=document.createElement("canvas");e.width=2480;e.height=3508;let t=e.getContext("2d");t.fillStyle="#ffffff";t.fillRect(0,0,e.width,e.height);if(currentMode==='id'){let o=(e.height-1426)/2;let r=(img,x,y)=>{t.save();t.beginPath();t.roundRect(x,y,1011,638,30);t.clip();t.drawImage(img,x,y,1011,638);t.restore();t.lineWidth=3;t.strokeStyle="#cccccc";t.stroke()};if(imageStates.front.croppedResult)r(imageStates.front.croppedResult,734.5,o);if(imageStates.back.croppedResult)r(imageStates.back.croppedResult,734.5,o+638+150)}else{let r=(img,x,y)=>{t.save();t.beginPath();t.roundRect(x,y,1335,1020,30);t.clip();t.drawImage(img,x,y,1335,1020);t.restore();t.lineWidth=3;t.strokeStyle="#cccccc";t.stroke()};if(imageStates.front.croppedResult)r(imageStates.front.croppedResult,572.5,734);if(imageStates.back.croppedResult)r(imageStates.back.croppedResult,572.5,1754)}t.font="40px Inter, Arial";t.fillStyle="#7c7c7c";t.textAlign="center";t.fillText("Generated by: ID Card Scanner Pro - www.idcardscannerpro.com",e.width/2,3400);return e}function downloadPNG(){if(!imageStates.front.croppedResult&&!imageStates.back.croppedResult){showAlert("Scan at least one side!");return}let a=document.createElement("a");a.download=currentMode==='id'?"ID-Card-Scan.png":"Passport-Scan.png";a.href=getA4Canvas().toDataURL("image/png");a.click()}function downloadJPG(){if(!imageStates.front.croppedResult&&!imageStates.back.croppedResult){showAlert("Scan at least one side!");return}let a=document.createElement("a");a.download=currentMode==='id'?"ID-Card-Scan.jpg":"Passport-Scan.jpg";a.href=getA4Canvas().toDataURL("image/jpeg",1);a.click()}function downloadPDF(){if(!imageStates.front.croppedResult&&!imageStates.back.croppedResult){showAlert("Scan at least one side!");return}let{jsPDF:e}=window.jspdf,t=new e({orientation:"p",unit:"mm",format:"a4"});t.addImage(getA4Canvas().toDataURL("image/jpeg",.95),"JPEG",0,0,210,297);t.save(currentMode==='id'?"ID-Card-Scan.pdf":"Passport-Scan.pdf")}

  
  <!-- SCRIPT 7D: Mobile-Ready Print Engine -->

function printDirectly(){if(!imageStates.front.croppedResult&&!imageStates.back.croppedResult){showAlert("Scan at least one side before printing!");return}const e=getA4Canvas();e.toBlob(function(o){const t=URL.createObjectURL(o),r=window.open(t,"_blank");if(!r){showAlert("Please allow popups to print directly.");return}r.document.write(`<!DOCTYPE html><html><head><title>Print - ${currentMode==='id'?'ID Card':'Passport'}</title><style>*{margin:0;padding:0;}html,body{width:100%;height:100%;overflow:hidden;background:#fff;}img{display:block;width:210mm;height:297mm;object-fit:contain;margin:0 auto;}@page{size:A4;margin:0;}@media print{body{-webkit-print-color-adjust:exact;}img{width:100%;height:100%;}}</style></head><body><img src="${t}" id="printImg" /><script>document.getElementById('printImg').onload=function(){setTimeout(function(){window.print();},500);};<\/script></body></html>`),r.document.close(),setTimeout(()=>URL.revokeObjectURL(t),1e4)},'image/jpeg',1.0)}
